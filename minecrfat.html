<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<title>Mini Minecraft 3D – Crafting Tabulka</title>
<style>
body{margin:0;overflow:hidden;background:black;font-family:sans-serif;}
#ui{position:fixed;top:10px;left:10px;color:white;font-size:18px}
#inv{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);display:flex;gap:5px}
.slot{width:40px;height:40px;background:#ccc;border:2px solid black;text-align:center;line-height:40px;font-size:12px;white-space:pre;}
.active{border-color:red}
#craft{
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#333;
  padding:10px;
  display:none;
  color:white;
}
#grid{display:grid;grid-template-columns:repeat(3,50px);grid-gap:5px;margin-bottom:10px}
.grid-slot{width:50px;height:50px;background:#555;text-align:center;line-height:50px;font-size:14px;cursor:pointer}
#result{width:50px;height:50px;background:#222;text-align:center;line-height:50px;margin-bottom:10px;cursor:pointer}
#death{
  position:fixed;
  top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,0.85);
  color:white;
  font-size:50px;
  display:none;
  text-align:center;
  padding-top:20%;
}
#death button{
  font-size:25px;
  margin-top:20px;
  padding:10px 20px;
}
</style>
</head>
<body>

<div id="ui">❤️ <span id="hp">100</span> | C = Crafting</div>
<div id="inv"></div>

<div id="craft">
  <h3>Crafting 3×3</h3>
  <div id="grid"></div>
  <div id="result">?</div>
  <button onclick="toggleCraft()">Zavřít</button>
</div>

<div id="death">
  ☠️ Zemřel jsi!
  <br>
  <button onclick="respawn()">Znovu ožít</button>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.152/build/three.min.js"></script>
<script>
/* === ZÁKLAD === */
let dead = false;

const scene=new THREE.Scene();
scene.background=new THREE.Color(0x87ceeb);
const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,0.1,1000);
camera.position.set(0,2,5);
const renderer=new THREE.WebGLRenderer();
renderer.setSize(innerWidth,innerHeight);
document.body.appendChild(renderer.domElement);

scene.add(new THREE.AmbientLight(0xffffff,0.4));
const sun=new THREE.DirectionalLight(0xffffff,0.8);
sun.position.set(10,20,10);
scene.add(sun);

/* === BLOKY === */
const geo=new THREE.BoxGeometry(1,1,1);
const mats={
  grass:new THREE.MeshLambertMaterial({color:0x00aa00}),
  dirt:new THREE.MeshLambertMaterial({color:0x8b4513}),
  stone:new THREE.MeshLambertMaterial({color:0x777777}),
  wood:new THREE.MeshLambertMaterial({color:0xa0522d})
};

let world={};
function key(x,y,z){return x+","+y+","+z}
function addBlock(x,y,z,t){
  const m=new THREE.Mesh(geo,mats[t]);
  m.position.set(x,y,z);
  scene.add(m);
  world[key(x,y,z)]={mesh:m,type:t};
}

/* === SVĚT === */
for(let x=-15;x<15;x++)for(let z=-15;z<15;z++){
  addBlock(x,0,z,"grass");
  addBlock(x,-1,z,"dirt");
  addBlock(x,-2,z,"stone");
  if(Math.random()<0.05)addBlock(x,1,z,"wood");
}

/* === INVENTÁŘ === */
let inv={
  grass:0,dirt:0,stone:0,wood:0,plank:0,stick:0,sword:0
};
let selected="dirt";
const invDiv=document.getElementById("inv");
function drawInv(){
  invDiv.innerHTML="";
  for(let k in inv){
    let d=document.createElement("div");
    d.className="slot"+(k===selected?" active":"");
    d.textContent=k+"\n"+inv[k];
    invDiv.appendChild(d);
  }
}
drawInv();

/* === CRAFTING TABULKA 3×3 === */
const gridDiv=document.getElementById("grid");
const resultDiv=document.getElementById("result");
let grid=Array(9).fill(null);

// vytvoření grid
for(let i=0;i<9;i++){
  const slot=document.createElement("div");
  slot.className="grid-slot";
  slot.dataset.index=i;
  slot.onclick=()=>{
    if(selected && inv[selected]>0){
      grid[i]=selected;
      inv[selected]--;
      drawGrid();
      drawInv();
      updateResult();
    }
  };
  gridDiv.appendChild(slot);
}

// recepty
const recipes=[
  {out:"plank",qty:4,pattern:["wood",null,null,null,null,null,null,null,null]},
  {out:"stick",qty:4,pattern:[null,"plank",null,null,"plank",null,null,null,null]},
  {out:"sword",qty:1,pattern:[null,"stone",null,null,"stone",null,null,"stick",null]}
];

function drawGrid(){
  gridDiv.childNodes.forEach((slot,i)=>{
    slot.textContent=grid[i]?grid[i]:"";
  });
}

function matchRecipe(){
  for(let r of recipes){
    let match=true;
    for(let i=0;i<9;i++){
      if(r.pattern[i]!==grid[i]){match=false;break;}
    }
    if(match)return r;
  }
  return null;
}

function updateResult(){
  let r=matchRecipe();
  resultDiv.textContent=r?r.out+" ("+r.qty+")":"?";
}

resultDiv.onclick=()=>{
  let r=matchRecipe();
  if(!r)return;
  inv[r.out]+=r.qty;
  grid.forEach((g,i)=>{if(g)grid[i]=null});
  drawGrid();
  drawInv();
  updateResult();
}

/* === CRAFT MENU === */
const craftDiv=document.getElementById("craft");
function toggleCraft(){
  craftDiv.style.display=craftDiv.style.display==="none"?"block":"none";
}

/* === OVLÁDÁNÍ === */
let keys={},yaw=0,pitch=0,hp=100;
document.body.onclick=()=>{ if(!dead) document.body.requestPointerLock(); };
document.addEventListener("mousemove",e=>{
  if(document.pointerLockElement && !dead){
    yaw-=e.movementX*0.002;
    pitch-=e.movementY*0.002;
    pitch=Math.max(-1.5,Math.min(1.5,pitch));
    camera.rotation.set(pitch,yaw,0);
  }
});
onkeydown=e=>{
  keys[e.key]=true;
  if(e.key==="c")toggleCraft();
  if(e.key==="1")selected="dirt";
  if(e.key==="2")selected="stone";
  if(e.key==="3")selected="wood";
};
onkeyup=e=>keys[e.key]=false;

/* === ZOMBÍCI === */
let mobs=[];
function spawnMob(x, z) {
  const group = new THREE.Group();

  // HLAVA
  const head = new THREE.Mesh(
    new THREE.BoxGeometry(0.8, 0.8, 0.8),
    new THREE.MeshLambertMaterial({ color: 0x00aa00 })
  );
  head.position.set(0, 1.8, 0);
  group.add(head);

  // TĚLO
  const body = new THREE.Mesh(
    new THREE.BoxGeometry(1, 1.2, 0.5),
    new THREE.MeshLambertMaterial({ color: 0x006600 })
  );
  body.position.set(0, 1, 0);
  group.add(body);

  // RUCE
  const armGeo = new THREE.BoxGeometry(0.3, 1, 0.3);
  const armMat = new THREE.MeshLambertMaterial({ color: 0x006600 });

  const armL = new THREE.Mesh(armGeo, armMat);
  armL.position.set(-0.65, 1.2, 0);
  group.add(armL);

  const armR = new THREE.Mesh(armGeo, armMat);
  armR.position.set(0.65, 1.2, 0);
  group.add(armR);

  // NOHY
  const legGeo = new THREE.BoxGeometry(0.4, 1, 0.4);
  const legMat = new THREE.MeshLambertMaterial({ color: 0x333333 });

  const legL = new THREE.Mesh(legGeo, legMat);
  legL.position.set(-0.3, 0.3, 0);
  group.add(legL);

  const legR = new THREE.Mesh(legGeo, legMat);
  legR.position.set(0.3, 0.3, 0);
  group.add(legR);

  group.position.set(x, 0, z);
  group.hp = 20;

  scene.add(group);
  mobs.push(group);
}

for(let i=0;i<5;i++)spawnMob(Math.random()*10-5,Math.random()*10-5);

/* === HITOVÁNÍ MYŠÍ === */
let lastHit = 0;
const hitCooldown = 300;
const hitRange = 2.2;

onmousedown = e => {
  if (dead) return;

  // ÚTOK
  if (e.button === 0) {
    const now = performance.now();
    if (now - lastHit > hitCooldown) {
      lastHit = now;

      let forward = new THREE.Vector3(0, 0, -1).applyEuler(camera.rotation);
      let closest = null;
      let closestDist = hitRange;

      mobs.forEach(m => {
        let toMob = m.position.clone().sub(camera.position);
        let dist = toMob.length();

        if (dist < closestDist && toMob.normalize().dot(forward) > 0.5) {
          closest = m;
          closestDist = dist;
        }
      });

      if (closest) {
        closest.hp -= inv.sword ? 20 : 5;
        if (closest.hp <= 0) {
          scene.remove(closest);
          mobs = mobs.filter(m => m !== closest);
        }
      }
    }
  }

  // STAVĚNÍ
  if (e.button === 2) {
    const ray = new THREE.Raycaster();
    ray.setFromCamera({ x: 0, y: 0 }, camera);
    let hit = ray.intersectObjects(Object.values(world).map(b => b.mesh));
    if (!hit.length) return;

    let p = hit[0].object.position;
    let n = hit[0].face.normal;

    if (inv[selected] > 0) {
      addBlock(p.x + n.x, p.y + n.y, p.z + n.z, selected);
      inv[selected]--;
      drawInv();
    }
  }
};

oncontextmenu=e=>e.preventDefault();

/* === SMRT HRÁČE === */
function death(){
  if(dead) return;
  dead = true;
  document.exitPointerLock();
  document.getElementById("death").style.display="block";
}

function respawn(){
  hp = 100;
  document.getElementById("hp").textContent = hp;
  camera.position.set(0,2,5);
  dead = false;
  document.getElementById("death").style.display="none";
}

/* === LOOP === */
let vy=0,onGround=false;
function loop(){
  requestAnimationFrame(loop);

  if(dead){
    renderer.render(scene,camera);
    return;
  }

  let s=0.1;
  let dir=new THREE.Vector3((keys.a?-1:0)+(keys.d?1:0),0,(keys.w?-1:0)+(keys.s?1:0));
  dir.applyEuler(camera.rotation);
  camera.position.addScaledVector(dir,s);

  vy-=0.01;
  camera.position.y+=vy;
  if(camera.position.y<2){camera.position.y=2;vy=0;onGround=true;}
  if(keys[" "]&&onGround){vy=0.2;onGround=false;}

  mobs.forEach(m=>{
    let d=camera.position.clone().sub(m.position);
    if(d.length()<10)m.position.addScaledVector(d.normalize(),0.02);
    if(m.position.distanceTo(camera.position)<1){
      hp--;
      document.getElementById("hp").textContent=hp;
      if(hp<=0) death();
    }
  });

  renderer.render(scene,camera);
}
loop();

onresize=()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
};
</script>
</body>
</html>
